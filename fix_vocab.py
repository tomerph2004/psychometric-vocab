#!/usr/bin/env python3
import json, re, sys

# Read the file
with open('/root/.openclaw/workspace/psychometric/index.html', 'r') as f:
    content = f.read()

# Extract VOCAB array
m = re.search(r'const VOCAB = (\[.*?\]);', content, re.DOTALL)
if not m:
    print("ERROR: Could not find VOCAB array")
    sys.exit(1)

vocab_str = m.group(1)
vocab = json.loads(vocab_str)
print(f"Original entries: {len(vocab)}")

# === SPACING FIXES ===
# Map of broken words to fixed words
spacing_fixes = {
    "שבער צון": "שבע רצון",
    "סימפ טום": "סימפטום",
    "אנפ ילאות": "אנפילאות",
    "אנפ ילה": "אנפילה",
    "הסת ייגות": "הסתייגות",
    "אימ ננטי": "אימננטי",
    "אימ ננטית": "אימננטית",
    "מבויס תום": "מבוי סתום",
    "בנפשח פצה": "בנפש חפצה",
    "יחידס גלה": "יחיד סגלה",
    "דופר צופי": "דו פרצופי",
    "סגר גציה": "סגרגציה",
    "מןהש יתין": "מן השיתין",
    "מןהמ ניין": "מן המניין",
    "לאיןש יעור": "לאין שיעור",
    "קומ זיץ": "קומזיץ",
    "קונוונצ יההתנהגות": "קונוונציה התנהגות",
    "קונפורמ יסט": "קונפורמיסט",
    "קונפ ליקט": "קונפליקט",
    "איד אולוגיה": "אידאולוגיה",
    "האיד אולוגיה": "האידאולוגיה",
    "אינהר נטי": "אינהרנטי",
    "אינט לקט": "אינטלקט",
    "בירוקרט יהבכל": "בירוקרטיה בכל",
    "דוןק ישוט יות": "דון קישוטיות",
    "סטר אוטיפ": "סטראוטיפ",
    "טורב ינה": "טורבינה",
    "אלט רוא יזם": "אלטרואיזם",
    "אלט רוא יסטים": "אלטרואיסטים",
    "דטרמ יניזם": "דטרמיניזם",
    "דיא לקט": "דיאלקט",
    "אמב יוול נטי": "אמביוולנטי",
    "קלפ טומ ניה": "קלפטומניה",
    "ליבר ליזם": "ליברליזם",
    "רטור יקה": "רטוריקה",
    "ציק לון": "ציקלון",
    "אבט יפוס": "אבטיפוס",
    "פוב ליצ יסטי": "פובליציסטי",
    "פוב ליצ יסט": "פובליציסט",
    "פטר יוט": "פטריוט",
    "פטר נליזם": "פטרנליזם",
    "פטר נליסטית": "פטרנליסטית",
    "פילנת רופ": "פילנתרופ",
    "לביר ינת": "לבירינת",
    "אספ לנית": "אספלנית",
    "אינפ לציה": "אינפלציה",
    "במפ גיע": "במפגיע",
    "בןב ליעל": "בן בליעל",
    "לקס יקון": "לקסיקון",
    "הלקס יקון": "הלקסיקון",
    "פרימ יטיבי": "פרימיטיבי",
    "פרמ ננטי": "פרמננטי",
    "סולידר יות": "סולידריות",
    "סולידר יות": "סולידריות",
    "טולר נטי": "טולרנטי",
    "טולר נטיות": "טולרנטיות",
    "טרנס פורמציה": "טרנספורמציה",
    "סור יאליסטי": "סוריאליסטי",
    "לגיט ימי": "לגיטימי",
    "דיא לוג": "דיאלוג",
    "סנט ימנטלי": "סנטימנטלי",
    "ארכ יפלג": "ארכיפלג",
    "ונד ליזם": "ונדליזם",
    "רפר זנטט יבי": "רפרזנטטיבי",
    "דומ יננטי": "דומיננטי",
    "קפיט ליזם": "קפיטליזם",
    "פרוב יזורי": "פרוביזורי",
    "אקט יבי": "אקטיבי",
    "קולקט יבי": "קולקטיבי",
    "טוט אלי": "טוטאלי",
    "טוט ליטרי": "טוטליטרי",
    "דיקט טור": "דיקטטור",
    "אומ ניפוט נטי": "אומניפוטנטי",
    "פור יטניות": "פוריטניות",
    "פלור ליזם": "פלורליזם",
    "מגלומ ניה": "מגלומניה",
    "סוב לנות": "סובלנות",
    "בסוב לנות": "בסובלנות",
    "קוב לנה": "קובלנה",
    "חיד לון": "חידלון",
    "לחיד לון": "לחידלון",
    "תוב עני": "תובעני",
    "שלומ יאל": "שלומיאל",
    "אקלקטי": "אקלקטי",
    "רנדומלי": "רנדומלי",
    "מרקס יזם": "מרקסיזם",
    "פרוט רוט": "פרוטרוט",
    "בפרוט רוט": "בפרוטרוט",
    "קרד ינלי": "קרדינלי",
    "קונקרטי": "קונקרטי",
    "ויט אלי": "ויטאלי",
    "סוסט רויאני": "סוס טרויאני",
    "אור לוגין": "אורלוגין",
    "טרק לין": "טרקלין",
    "אתא יסט": "אתאיסט",
    "התלק חות": "התלקחות",
    "התרבר בות": "התרברבות",
    "התרש לות": "התרשלות",
    "התנוד דות": "התנודדות",
    "השתמ טות": "השתמטות",
    "הסת גלות": "הסתגלות",
    "השתומ מות": "השתוממות",
    "הסתוד דות": "הסתודדות",
    "הצט נפות": "הצטנפות",
    "השת נקות": "השתנקות",
    "אבסולוטי": "אבסולוטי",
    "אור בני": "אורבני",
    "אור בניים": "אורבניים",
    "מוסרכ ליות": "מוסר כליות",
    "ביק יצה": None,  # remove - fragment
    "פוזמ קאות": None,  # remove - fragment
    "בקדחת נות": None,  # remove - fragment
    "הגד ילים": None,  # remove
    "המכ מורת": "המכמורת",
    "המכ מורת": "המכמורת",
    "הסט יגמה": None,  # fragment
    "קונוונציה": None,  # fragment - def is continuation
    "פושטאת עורות": None,  # fragment
    "רובצת לפתחו": None,  # fragment
    "ליאור חזרש דוף": None,  # fragment
    "הרבהת גרנים": None,  # fragment
    "דבריו זכו לתהודה": None,  # fragment
    "המחלה פשטה": None,  # fragment
    "לדרי הרחוב": None,  # fragment
    "פרף": None,  # fragment - def is sentence continuation
    # "פושה" - keep, has real definition
    "המכ מורת": "המכמורת",
    "סימפ טום": "סימפטום",
}

# More specific fragment entries to remove (by word AND definition match)
fragments_to_remove = [
    # word, definition substring
    ("הסט יגמה", "שיש להם אוכל טוב"),
    ("קונוונציה", "ספרותית ומופיעה"),
    ("פושטאת עורות", "לקוחותיו"),
    ("רובצת לפתחו", "של המנהל"),
    ("ליאור חזרש דוף", "מטיולו"),
    ("הרבהת גרנים", "בשוק"),
    ("דבריו זכו לתהודה", "רבה בקרב"),
    ("המחלה פשטה", "בארץ"),
    ("לדרי הרחוב", "בעיר"),
    ("דשב", "חולצתו"),
    ("התבדרו", "בגינה"),
    ("העוון", "שביצע"),
    ("הדרג", "הניהולי"),
    ("ספונים", "בביתנו"),
    ("פרף", "את מעילו"),
    ("בדוק", "של דמעות"),
    ("העיר", "ללכת על רגליו"),
    ("עיר", "ולד של חמור"),
    ("הצורף", "הכין שרשרת"),
    ("החשה", "את חניכיו"),
    ("המחתרת", "של המורדים"),
    ("מיגור", "הטרור"),
    ("חרך", "את העוף"),
    ("סיגים", "לחברות ההייטק"),
    ("סייד", "את קירות"),
    ("עכורים", "וכן לא ראויים"),
    ("רכס", "את מכנסיו"),
    ("כיבדתי", "את חבריי"),
    ("חכליליים", "של שקיעה"),
    ("החולה הפך כחוש", "בגלל תרופות"),
    ("שוחות", "על מנת לזרוע"),
    ("השומה", "שעל לחייה"),
    ("מהעל", "המורה להחדיר"),
    ("אישש", "את טענתו"),
    ("השתמט", "מגיוס לצבא"),
    ("הולמת", "אותך"),
    ("המימרה", "'וְאָ הַ בְ תָ"),
    ("מסלפת", "את האמת"),
    ("מסתגלים", "להתחממות"),
    ("ניחן", "ביכולת טיפוס"),
    ("סילוף", None),  # keep - has real def
    ("סיח", None),  # keep
    ("הכמין", "את האפיקומן"),
    ("המכבש", "כדי ליישרו"),
    ("למכורתו", "הדירו שינה"),
    ("הפריך", "את טענתו"),
    ("השבחת", "זני התפוח"),
    ("נוצתה", "לרסיסים"),
    ("נטש", None),  # keep
    ("כילות", "בגלל כמות"),
    ("סותתו", "עוד לפני"),
    ("בפלחן", "האל היווני"),
    ("קורי", "העכביש"),
    ("בקוף", "ולכן אמי"),
    ("קצבה", "הממשלה תקציב"),
    ("שלש לות", "כדי שלא"),
    ("שמו לאל", "את האפשרות"),
    ("הציגו ככליר יק", None),  # fix spacing instead
    ("שיף", "את השולחן"),
    ("שנתות", None),  # keep actual word
    ("בנה שובך", "ליונים"),
    ("שובך", None),  # keep
    ("נקלה", None),  # keep
    ("הצי", "הגדול ביותר"),
    ("נצנזוס", "מוחלט לגבי"),
    ("אימ ננטית", "ואני מצר"),
    ("בירוקרט יהבכל", "הנוגע להיתרי"),
    ("האיד אולוגיה", "הנאצית"),
    ("אלט רוא יסטים", "ולכן דואגים"),
    ("אישש", "את טענתו"),
    ("סיגים", "לחברות"),
    ("סייד", "את קירות"),
    ("עכורים", "וכן לא"),
    ("רכס", "את מכנסיו"),
    ("כיבדתי", "את חבריי"),
    ("חכליליים", "של שקיעה"),
    ("בדוק", "של דמעות"),
    ("שוחות", "על מנת לזרוע"),
    ("הצורף", "הכין שרשרת"),
    ("החשה", "את חניכיו"),
    ("המחתרת", "של המורדים"),
    ("מיגור", "הטרור"),
    ("חרך", "את העוף"),
    ("מהעל", "המורה להחדיר"),
    ("אישש", "את טענתו"),
    ("השתמט", "מגיוס לצבא"),
    ("הולמת", "אותך"),
    ("מסלפת", "את האמת"),
    ("מסתגלים", "להתחממות"),
    ("ניחן", "ביכולת טיפוס"),
    ("הכמין", "את האפיקומן"),
    ("המכבש", "כדי ליישרו"),
    ("למכורתו", "הדירו שינה"),
    ("הפריך", "את טענתו"),
    ("השבחת", "זני התפוח"),
    ("נוצתה", "לרסיסים"),
    ("כילות", "בגלל כמות"),
    ("סותתו", "עוד לפני"),
    ("בפלחן", "האל היווני"),
    ("קורי", "העכביש"),
    ("בקוף", "ולכן אמי"),
    ("קצבה", "הממשלה תקציב"),
    ("שלש לות", "כדי שלא"),
    ("שמו לאל", "את האפשרות"),
    ("שיף", "את השולחן"),
    ("הצי", "הגדול ביותר"),
    ("נצנזוס", "מוחלט לגבי"),
    ("פניו", "נאלץ להתפכח"),
    ("ברכיו", "של הנער"),
    ("בדעתו", "לגבי יציאה"),
    ("ימיו", "בגיל49"),
    ("הטמיר", "על הגלוי"),
    ("הייבום", "הייתה נפוצה"),
    ("ידוי", "האבנים לעבר"),
    ("גמלוניותו", "היא הסיבה"),
    ("דרד קים", "ולכן יש להשגיח"),
    ("המסואבת", "חצתה"),
    ("הדליפו", "לתקשורת"),
    ("זועקות", "חָ מָ ס"),
    ("מכזב", "בכם"),
    ("הליבה", "ולהיבחן"),
    ("מלטש", "את .היהלומים"),
    ("מדחי", "אל דֶ חִׁ י"),
    ("להאביס", "חיות המשק"),
    ("ההדום", "לטובת מנוחת"),
    ("שותת", "דם עד"),
    ("לתולדות", "מעניינות"),
    ("הולד", "החדש שהצטרף"),
    ("אבותט יפוס", "שונים, לרבות"),
    ("עללבם", "של הוריו"),
    ("זלזלים", "רבים הנדלקים"),
    ("הדין התובעהזם", "את טענותיו"),
    ("הינה נביאהבע ירה", "בתחום"),
    ("אתלבו", "וסרב לבקשתו"),
    ("מדבר עללבו", "של כל אחד"),
    ("צרור מכתבים שנשלחו", "עבורנו"),
    ("הרא ווה", "היא לחשוף"),
    ("חתר ניים", "הפועלים"),
    ("מטרשים", "רבים המונחים"),
    ("יצאהמד עתה", "מרוב דאגותיה"),
    ("הלין אתש כרו", "למעלה מתשעה"),
    ("הלכו לעבדון", None),  # not in list
    ("להכות עלחטא", "זה לאורך"),
    ("הלנתשכר", None),  # keep - real word
    ("שמח לאידו", "במקום לזכות"),
    ("בקש תולפני", "ילדיו בדבר"),
    ("צידדתי", "בדעתו של"),
    ("ריצה", None),  # keep - has real def
    ("לרצות", "אותה על כך"),
    ("השורר", "בירושלים"),
    ("קרנות", "ולא עושה"),
    ("יחידס גלה", "בדורו"),
    ("נתנה לבנה יפויכח", "על נכסיה"),
    ("לילותש מורים", "מכיוון שהיה"),
    ("עיניומר אות", "והוא המשיך"),
    ("הסט טוס", "של שלי"),
    ("הפ צע ים", None),  # not exact
    ("מרופטים", "ולכן ביקשתי"),
    ("משברים", "רבים לעומת"),
    ("מוגלב", None),  # keep
    ("הקולגיאליות", "היא ערך"),
    ("להב ליג", "על דבריו"),
    ("אוריאלה גיף", "את חלון"),
    ("שזכה לסגידה", "בחייו"),
    ("מוגפים", "ולכן אף"),
    ("זהטומןב חובו", "השלכות"),
    ("בירכת יים", "של הספינה"),
    ("פוסחת עלשתיהסעפים", "האם להתגייס"),
    ("המורהחרקהש ניה", "ולא העירה"),
    ("לביבר", "בחיפה"),
    ("בבית הגנזים", "של היכל"),
    ("ובעטיה", "חסמו את"),
    ("הדס השתמשה בגמחה", "שבקיר"),
    ("ירין ושלומיהת כתשו", "ביניהם"),
    ("האר יכהאפה", "כאשר בנה"),
    ("הומוגנים", "בדעתם"),
    ("המעסיקה לין", "את השכר"),
    ("ביד", "ומשפיע"),
    ("הדרג", "הניהולי"),
    ("ספונים", "בביתנו"),
    ("פג", None),  # keep
    ("הדרכון שליפג", "לפני חודש"),
    ("הפור ,הראו כיאחוז", "גבוה"),
    ("צפיח יות", "שהוכנו בבית"),
    ("בקלות ראש", "לתמרורים"),
    ("בארצות הברית הקרטל", "אסור"),
    ("רזי", None),  # keep? not found
    ("היא מדינהר יבונית", "ואינה כפופה"),
    ("ושמ יםאתמבט חנו", "בו שישמור"),
    ("לשעהק לה.למרות", "שהביקור"),
    ("התרוד", "הוא כלי"),
    ("תשואות", "רבות מהקהל"),
    ("הםנתנו להתשר", "גבוהה"),
    # More fragments from definition being a sentence continuation
    ("באישון לילה על-", "מנת להאזין"),
    ("סאה ,כיום מודדים8", "ליטרים"),
    ("בסוב לנות", "אחד כלפי"),
    ("לעיר רפאים", "הוא מלחמות"),
    ("בגינו", None),  # keep real word
    ("מזלו", "והוא הפסיד"),
    ("לסק נדל", "נוסף לאחר"),
    ("ושוקקח יים.", "שור ראה"),
    ("לשכוי", "בינה להבחין"),
    ("כאשר אישה הרהתאבה", "למאכל"),
    ("גלעד זיכרון", "לנופלים"),
    ("במצ ילה", "בכניסה לביתה"),
    ("ובעלת קומה", "ולכן שימשה"),
    ("במרי", "ולא הסכים"),
    ("רפאל היה נושה", "כסף לחברו"),
    ("נואפת", "עם מישהו"),
    ("הסוור", "בנמל הוא"),
    ("שעל פניו", "אין לו מה"),
    ("בקביים", "לאחר ששבר"),
    ("הראיות קונקרט יות", "הן אלו"),
    ("במגוב", "כדי לנקות"),
    ("יוני היהמר נפש", "לאחר שהעסק"),
    ("הזוט", "שבכלי מכיוון"),
    ("מזר בובית", "שבקומקום"),
    ("טחו", "ולכן לא היה"),
    ("בבינה", "רבה, שכן"),
    ("משועבדת", "לעבודתה"),
    ("שאב ניהשפה", "היו צבועות"),
    ("אדוות", "במים סביבי"),
    ("מבוזרים", "בקהילות שונות"),
    ("למדמנה", "את כל החפצים"),
    ("בפלג", "גופו התחתון"),
    ("הפר גוד", "בביתו בזמן"),
    ("בצורמח צבתו", "גרמניה"),
    ("קוששו", "קרשים"),
    ("ברום שלכ-", "8,848"),
    ("שהגיע לגבורות", "נולד ליצחק"),
    ("גבהוממ נוהד ברים", "לא הבין"),
    ("בגזוזטרה", "שבביתנו"),
    ("זלעפות", "נשבה בחוץ"),
    ("חלחלו", "אל תוך"),
    ("לדינה היהחשק", "לאכול"),
    ("חרדה", "לשלומו"),
    ("כסיות", "לכפות"),
    ("העולל", "בידיה"),
    ("כלכלאתש יבתם", "של הוריו"),
    ("נופת", None),  # keep
    ("תפקידו שלהנתיך", "הוא להגן"),
    ("סוגיית", "הר הבית"),
    ("חלחלו", "אל תוך"),
    ("רינן", "בחתונתו"),
    ("יובב גורס", "שמההמשלה"),
    ("ההגד", "הגזעני"),
    ("בבטןרכה", "של יריבו"),
    ("בזילות ,לכן הוא", "החליט"),
    ("זרעמרע ים", None),
    ("בניםמשח יתים עזבו", None),
    ("חשוך בנים", None),  # keep
    ("הצלף עמד בפוזיציה", "טובה כדי"),
    ("פוזמ קאות", "לחורף"),
    ("הירקןפ ילח", "את האבטיח"),
    ("דרד קים", "ולכן יש"),
    ("ואין", "לֹו קַ רְ נָיִׁם"),
    ("ויחרא פו.\"", None),
    ("שדר החדשותארכן", "מאוד"),
    ("ובארשת פנים", "רצינית"),
    ("שבע עיניים", "כי הוא שובב"),
    ("התמרה,", "זן א"),
    ("הכרך", "בחיפוש אחר"),
    ("האדוןכתתאתר גליו", "על מנת"),
    ("הלקס יקון", "של ילד הכפר"),
    ("התפרקד", "על דשא"),
    ("הקשישמתנה", "את צרותיו"),
    ("להתיק", "עיניה מהנוף"),
    ("סרח ינו", None),  # keep - real word entry
    ("מתינותם", "של שני הצדדים"),
    ("קיימתסת ירה", "באופיו"),
    ("שהצריח", "גבוה ומפואר"),
    ("בצפרן", "את ספרי"),
    ("השר בוט", "של דה וינצ'י"),
    ("שרירותיים", "ולא צודקים"),
    ("מרשלת", "ולכן לא קיבל"),
    ("האופהר ידד", "את הבצק"),
    ("נמחה", None),  # keep
    ("נלוז", None),  # keep
    ("נסרת", None),  # keep
    ("אתהש נתות", "למדידת נפח"),
    ("קפאה עלשמריה", "ובתגובה"),
    ("סמוכ יםעל שולחנו", "של המלך"),
    ("ידך", "מֵ אָ חִׁ יָך"),
    ("הפ יל אתח תתו", None),  # fix spacing
    ("רכאות", "המוסמכות"),
    ("פריעטם", "של המועמדים"),
    # unit 9 fragments
    ("באר זים\"", None),
    ("משושות", "רבות"),
    ("קובץ הלכות שלהתורה", "שבעל"),
    ("למש נתו", "של שפינוזה"),
    # Additional continuation fragments
    ("שלהגיבן", "והבעיה"),
    ("הגיבן", None),  # keep the first one with real def
    ("וביוםהשב יעיתשבת", None),
    ("פעוט ,ולכן לאמשנה", "היכן"),
]

# Build a set of entries to remove
removed = 0
fixed = 0
new_vocab = []

for entry in vocab:
    word = entry.get("word", "")
    defn = entry.get("definition", "")
    
    should_remove = False
    
    # Check fragment removal list
    for fw, fd in fragments_to_remove:
        if word == fw:
            if fd is None:
                # Only remove if explicitly None (meaning always remove this word)
                # Actually None means "don't remove based on this rule alone"
                pass
            elif fd in defn:
                should_remove = True
                break
    
    # Check spacing fixes that map to None (remove)
    if word in spacing_fixes and spacing_fixes[word] is None:
        should_remove = True
    
    if should_remove:
        removed += 1
        continue
    
    # Apply spacing fixes
    if word in spacing_fixes and spacing_fixes[word] is not None:
        entry["word"] = spacing_fixes[word]
        fixed += 1
    
    # Fix spacing in definitions and examples too (common patterns)
    
    new_vocab.append(entry)

# Write back
new_vocab_json = json.dumps(new_vocab, ensure_ascii=False)
new_content = content.replace(m.group(0), f'const VOCAB = {new_vocab_json};')

with open('/root/.openclaw/workspace/psychometric/index.html', 'w') as f:
    f.write(new_content)

print(f"Fixed spacing: {fixed}")
print(f"Removed fragments: {removed}")
print(f"Final entries: {len(new_vocab)}")
